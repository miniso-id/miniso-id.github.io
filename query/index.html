<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMS-X</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>

<h1>MMS-X</h1>
<h2>Product Query</h2>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Search here" autocomplete="off"/>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Scan Barcode</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= DATA INDEX ================= */
let barcodeIndex = new Map();
let nameIndex = [];
let history = [];

fetch('products.json')
  .then(r => r.json())
  .then(data => {
    for (const p of data) {
      p.b.split("/").forEach(code => {
        barcodeIndex.set(code.trim(), p);
      });
      nameIndex.push({ name: p.n.toLowerCase(), product: p });
    }
  });

/* ================= ELEMENT ================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");

/* ================= INPUT ================= */
input.addEventListener("input", e => {
  clearBtn.style.display = e.target.value ? "block" : "none";
  search(e.target.value);
});

/* ================= CLEAR ================= */
clearBtn.onclick = () => {
  input.value = "";
  clearBtn.style.display = "none";
  clearResult();
  input.focus();
};

/* ================= SEARCH ================= */
function search(q) {
  q = q.trim().toLowerCase();
  if (!q) return clearResult();

  if (barcodeIndex.has(q)) {
    beep(true);
    addHistory(q);
    return render([barcodeIndex.get(q)], q);
  }

  const results = [];
  for (let i = 0; i < nameIndex.length; i++) {
    if (nameIndex[i].name.includes(q)) {
      results.push(nameIndex[i].product);
      if (results.length === 1000) break;
    }
  }

  results.length ? beep(true) : beep(false);
  render(results, q);
}

/* ================= RENDER ================= */
function render(list, q="") {
  document.getElementById("result").innerHTML = list.map(p => `
    <div class="card ${p.b.includes(q) ? 'match' : ''}">
      <img src="${p.i}" loading="lazy">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div class="price">Regular : ${p.h || '-'}</div>
      </div>
    </div>
  `).join("");
}

function clearResult() {
  document.getElementById("result").innerHTML = "";
}

/* ================= QUAGGA SCANNER ================= */
document.getElementById("scanBtn").onclick = () => {
  const reader = document.getElementById("reader");
  reader.innerHTML = "";

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: reader,
      constraints: {
        facingMode: "environment",
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    },
    locator: {
      patchSize: "medium",
      halfSample: true
    },
    decoder: {
      readers: [
        "ean_reader",
        "ean_13_reader",
        "upc_reader",
        "upc_e_reader",
        "code_128_reader"
      ]
    },
    locate: true
  }, err => {
    if (err) {
      console.error(err);
      return;
    }
    Quagga.start();
  });

  let lastCode = "";
  Quagga.onDetected(data => {
    const code = data.codeResult.code;
    if (code === lastCode) return;
    lastCode = code;

    input.value = code;
    clearBtn.style.display = "block";

    beep(true);
    addHistory(code);
    search(code);

    Quagga.stop();
    Quagga.offDetected();
  });
};

/* ================= HISTORY ================= */
function addHistory(code) {
  if (history.includes(code)) return;
  history.unshift(code);
  if (history.length > 5) history.pop();

  document.getElementById("history").innerHTML =
    history.map(h => `<span>${h}</span>`).join("");
}

/* ================= BEEP ================= */
function beep(ok) {
  (ok ? beepOk : beepErr).play();
}
</script>

</body>
</html>
