<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<!-- ================= LOGIN ================= -->
<div id="loginBox">
  <h2>ğŸ” Login</h2>
  <input id="pin" type="password" inputmode="numeric" placeholder="Masukkan PIN">
  <button onclick="login()">Masuk</button>
</div>

<!-- ================= APP ================= -->
<div id="app" style="display:none">

<h1>MMS-X</h1>
<h2>Product Query</h2>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Scan / Cari produk" autocomplete="off">
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ğŸ“· Scan Barcode</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="reader" style="display:none"></div>

<h3>History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

</div>

<!-- AUDIO -->
<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= CONFIG ================= */
const AUTO_LOGOUT = 8 * 60 * 60 * 1000;

/* ================= USERS ================= */
const USERS = {
  "1111": { role: "staff" },
  "2222": { role: "supervisor" }
};

/* ================= LOGIN ================= */
function login(){
  const p = pin.value;
  if(!USERS[p]) return alert("PIN salah");

  localStorage.setItem("mms_login","1");
  localStorage.setItem("mms_role",USERS[p].role);
  localStorage.setItem("mms_login_time",Date.now());
  location.reload();
}

function logout(){
  localStorage.removeItem("mms_login");
  localStorage.removeItem("mms_role");
  localStorage.removeItem("mms_login_time");
  location.reload();
}

/* ================= SESSION CHECK ================= */
(function(){
  if(localStorage.getItem("mms_login")==="1"){
    if(Date.now() - localStorage.getItem("mms_login_time") > AUTO_LOGOUT){
      logout();
    } else {
      showApp();
    }
  } else {
    setTimeout(()=>pin.focus(),300);
  }
})();

function showApp(){
  loginBox.style.display="none";
  app.style.display="block";
  setTimeout(()=>searchInput.focus(),300);
}

/* ================= DATA ================= */
let barcodeIndex = new Map();
let nameIndex = [];
let history = [];

fetch("products.json")
.then(r=>r.json())
.then(data=>{
  data.forEach(p=>{
    p.b.split("/").forEach(c=>barcodeIndex.set(c.trim(),p));
    nameIndex.push({name:p.n.toLowerCase(),product:p});
  });
});

/* ================= SEARCH ================= */
searchInput.addEventListener("input",e=>{
  clearBtn.style.display=e.target.value?"block":"none";
  search(e.target.value);
});

clearBtn.onclick=()=>{
  searchInput.value="";
  clearBtn.style.display="none";
  result.innerHTML="";
  searchInput.focus();
};

function search(q){
  q=q.trim().toLowerCase();
  if(!q) return;

  if(barcodeIndex.has(q)){
    beep(true);
    addHistory(q);
    render([barcodeIndex.get(q)],q);
    return;
  }

  const r=[];
  for(const i of nameIndex){
    if(i.name.includes(q)){
      r.push(i.product);
      if(r.length>=1000) break;
    }
  }

  r.length?beep(true):beep(false);
  render(r,q);
}

function render(list,q){
  result.innerHTML=list.map(p=>`
  <div class="card ${p.b.includes(q)?"match":""}">
    <img src="${p.i}" loading="lazy">
    <div class="info">
      <b>${p.n}</b>
      <small>${p.b}</small>
      <div class="price">${p.h}</div>
    </div>
  </div>`).join("");
}

/* ================= HISTORY ================= */
function addHistory(c){
  if(history.includes(c)) return;
  history.unshift(c);
  if(history.length>5) history.pop();
  history.innerHTML=history.map(h=>`<span>${h}</span>`).join("");
}

/* ================= CAMERA SCAN ================= */
scanBtn.onclick=()=>{
  reader.style.display="block";

  const qr = new Html5Qrcode("reader");
  qr.start(
    { facingMode:{ exact:"environment" } },
    { fps:10, qrbox:{width:250,height:150} },
    code=>{
      qr.stop();
      reader.style.display="none";
      searchInput.value=code;
      clearBtn.style.display="block";
      search(code);
      searchInput.focus();
      searchInput.select();
    },
    ()=>{}
  );
};

/* ================= PDA SCANNER SUPPORT ================= */
document.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    search(searchInput.value);
    searchInput.focus();
    searchInput.select();
  }
});

/* ================= BEEP ================= */
function beep(ok){
  (ok?beepOk:beepErr).play();
}
</script>

</body>
</html>
