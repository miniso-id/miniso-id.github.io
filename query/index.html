<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
#reader{
  display:none;
  width:100%;
  max-width:360px;
  aspect-ratio:1/1;
  margin:10px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  position:relative;
}
#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}
#reader::after{
  content:"";
  position:absolute;
  inset:22%;
  border:2px dashed rgba(0,255,0,.7);
  border-radius:8px;
}
.status{
  text-align:center;
  font-size:12px;
  opacity:.6;
  margin-top:4px;
}
</style>
</head>

<body>

<center>
<h2>Product Query</h2>
<h3>MMS-X (beta)</h3>
<div id="status" class="status">Loading dataâ€¦</div>
</center>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Scan barcode / type here" autofocus disabled>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Camera Scan</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* =====================================================
   CONFIG
===================================================== */
const DATA_URL = "https://script.google.com/macros/s/AKfycbxm-R_4Ej_WOg8RrdFX4src7CczvWf6VIxCK4LcvsktQviA1XYy9VfnzqiTYUnxb-f7/exec"
const CACHE_KEY = "mms_products_cache_v1"
const CACHE_TIME = "mms_products_time_v1"
const CACHE_MAX_AGE = 6 * 60 * 60 * 1000 // 6 jam

/* =====================================================
   ELEMENT
===================================================== */
const input = document.getElementById("searchInput")
const clearBtn = document.getElementById("clearBtn")
const reader = document.getElementById("reader")
const historyDiv = document.getElementById("history")
const result = document.getElementById("result")
const statusEl = document.getElementById("status")

/* =====================================================
   STATE
===================================================== */
let barcodeIndex = new Map()
let nameIndex = []
let history = []
let DATA_READY = false

/* =====================================================
   INIT
===================================================== */
initData()

async function initData(){
  const cached = localStorage.getItem(CACHE_KEY)

  if(cached){
    buildIndex(JSON.parse(cached))
    DATA_READY = true
    input.disabled = false
    statusEl.textContent = "Ready (cached)"
    backgroundUpdate()
  }else{
    statusEl.textContent = "Downloading dataâ€¦"
    const data = await fetchData()
    buildIndex(data)
    saveCache(data)
    DATA_READY = true
    input.disabled = false
    statusEl.textContent = "Ready"
  }
}

/* =====================================================
   FETCH + CACHE
===================================================== */
async function fetchData(){
  const r = await fetch(DATA_URL)
  return await r.json()
}

function saveCache(data){
  localStorage.setItem(CACHE_KEY, JSON.stringify(data))
  localStorage.setItem(CACHE_TIME, Date.now())
}

async function backgroundUpdate(){
  try{
    const last = Number(localStorage.getItem(CACHE_TIME) || 0)
    if(Date.now() - last < CACHE_MAX_AGE) return

    const fresh = await fetchData()
    const old = localStorage.getItem(CACHE_KEY)

    if(!old || old.length !== JSON.stringify(fresh).length){
      buildIndex(fresh)
      saveCache(fresh)
      statusEl.textContent = "Data updated"
      setTimeout(()=>statusEl.textContent="Ready",2000)
    }
  }catch(e){
    console.warn("Silent update failed")
  }
}

/* =====================================================
   INDEX BUILDER
===================================================== */
function buildIndex(data){
  barcodeIndex.clear()
  nameIndex = []

  data.forEach(p=>{
    p.b.split("/").forEach(c=>{
      barcodeIndex.set(c.trim(), p)
    })
    nameIndex.push({
      name: p.n.toLowerCase(),
      product: p
    })
  })
}

/* =====================================================
   SEARCH
===================================================== */
input.oninput = e=>{
  clearBtn.style.display = e.target.value ? "block" : "none"
  search(e.target.value)
}

input.onkeydown = e=>{
  if(e.key === "Enter"){
    e.preventDefault()
    search(input.value.trim())
  }
}

clearBtn.onclick = ()=>{
  input.value = ""
  clearBtn.style.display = "none"
  result.innerHTML = ""
  input.focus()
}

function search(q){
  if(!DATA_READY) return

  q = q.toLowerCase()
  if(!q){ result.innerHTML=""; return }

  if(barcodeIndex.has(q)){
    beepOk.play()
    addHistory(q)
    render([barcodeIndex.get(q)])
    return
  }

  const r = []
  for(const item of nameIndex){
    if(item.name.includes(q)){
      r.push(item.product)
      if(r.length >= 100) break
    }
  }

  r.length ? beepOk.play() : beepErr.play()
  render(r)
}

function render(list){
  result.innerHTML = list.map(p=>`
    <div class="card">
      <img src="${p.i}" loading="lazy">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div>${p.h}</div>
      </div>
    </div>
  `).join("")
}

/* =====================================================
   HISTORY
===================================================== */
function addHistory(code){
  if(history.includes(code)) return
  history.unshift(code)
  if(history.length > 5) history.pop()
  historyDiv.innerHTML = history.map(h=>`<span>${h}</span>`).join("")
}

/* =====================================================
   CAMERA SCAN (STABLE)
===================================================== */
let scanning=false,lastCode="",stableCount=0
const REQUIRED_MATCH=3

scanBtn.onclick=()=>{
  if(scanning) return
  scanning=true
  reader.style.display="block"
  lastCode=""
  stableCount=0

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:reader,
      constraints:{facingMode:"environment"}
    },
    decoder:{readers:["ean_reader","ean_8_reader"]},
    locate:true
  },err=>{
    if(err){alert("Camera error");scanning=false;return}
    Quagga.start()
    Quagga.onDetected(onDetectedStable)
  })
}

function onDetectedStable(res){
  const code=res.codeResult.code
  if(code===lastCode) stableCount++
  else{ lastCode=code; stableCount=1 }

  if(stableCount<REQUIRED_MATCH) return

  Quagga.offDetected(onDetectedStable)
  Quagga.stop()
  reader.style.display="none"
  scanning=false

  input.value=code
  clearBtn.style.display="block"
  search(code)
  input.focus()
  input.select()
}
</script>

</body>
</html>
