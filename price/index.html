<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
#loginOverlay{position:fixed;inset:0;background:#f3f4f6;display:flex;align-items:center;justify-content:center;z-index:9999}
.login-card{max-width:360px;width:100%;padding:28px;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15);text-align:center}
.login-card input{width:100%;height:44px;margin-bottom:14px;padding:0 14px;border-radius:10px;border:1px solid #ddd}
.login-card button{width:100%;height:46px;border:none;border-radius:10px;background:#4f46e5;color:#fff}
#loginErr{color:#ef4444;font-size:14px;opacity:0}
#loginErr.show{opacity:1}

#reader{display:none;width:100%;max-width:360px;aspect-ratio:1/1;margin:10px auto;background:#000;border-radius:12px;overflow:hidden;position:relative}
#reader::after{content:"";position:absolute;inset:22%;border:2px dashed rgba(0,255,0,.7);border-radius:8px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginOverlay">
  <div class="login-card">
    <h3>Login MMS-X</h3>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="doLogin()">Masuk</button>
    <div id="loginErr">Username atau password salah</div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
<center>
<h2>Product Query</h2>
<h3 id="status">Loading indexâ€¦</h3>
</center>

<div class="search-box">
  <input id="searchInput" placeholder="Scan barcode / type here" disabled>
  <button id="scanBtn">ðŸ“· Scan</button>
</div>

<div id="reader"></div>
<div id="history"></div>
<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>
</div>

<script>
/* ================= LOGIN ================= */
let USERS=[]
fetch("users.json").then(r=>r.json()).then(d=>USERS=d)

function doLogin(){
  const u=loginUser.value.trim()
  const p=loginPass.value.trim()
  const ok=USERS.find(x=>x.user===u&&x.pass===p)
  if(!ok){loginErr.classList.add("show");return}
  localStorage.setItem("mms_auth","1")
  loginOverlay.style.display="none"
  app.style.display="block"
  initIndexedDB()
}
if(localStorage.getItem("mms_auth")){
  loginOverlay.style.display="none"
  app.style.display="block"
  initIndexedDB()
}

/* ================= INDEXED DB ================= */
let db, barcodeIndex=new Map(), nameIndex=[]
const DB_NAME="mmsx_db", STORE="index", URL="https://script.google.com/macros/s/AKfycbxm-R_4Ej_WOg8RrdFX4src7CczvWf6VIxCK4LcvsktQviA1XYy9VfnzqiTYUnxb-f7/exec"

function initIndexedDB(){
  const req=indexedDB.open(DB_NAME,1)
  req.onupgradeneeded=e=>{
    db=e.target.result
    db.createObjectStore(STORE)
  }
  req.onsuccess=e=>{
    db=e.target.result
    loadIndexFromDB()
  }
}

function loadIndexFromDB(){
  const tx=db.transaction(STORE)
  const store=tx.objectStore(STORE)
  const req=store.get("data")
  req.onsuccess=()=>{
    if(req.result){
      restoreIndex(req.result)
      ready("Ready (cached)")
      silentUpdate()
    }else{
      fetchAndBuild()
    }
  }
}

function restoreIndex(data){
  barcodeIndex=new Map(data.barcodeIndex)
  nameIndex=data.nameIndex
}

function saveIndex(){
  const tx=db.transaction(STORE,"readwrite")
  tx.objectStore(STORE).put({
    barcodeIndex:[...barcodeIndex],
    nameIndex,
    time:Date.now()
  },"data")
}

/* ================= FETCH & BUILD ================= */
function fetchAndBuild(silent=false){
  if(!silent)status.textContent="Building search engineâ€¦"
  fetch(URL).then(r=>r.json()).then(data=>{
    barcodeIndex.clear()
    nameIndex=[]
    data.forEach(p=>{
      p.b.split("/").forEach(c=>barcodeIndex.set(c.trim(),p))
      nameIndex.push({name:p.n.toLowerCase(),product:p})
    })
    saveIndex()
    if(!silent)ready("Ready")
  })
}

function silentUpdate(){
  fetchAndBuild(true)
}

function ready(msg){
  status.textContent=msg
  searchInput.disabled=false
  searchInput.focus()
}

/* ================= SEARCH ================= */
searchInput.oninput=e=>search(e.target.value)

function search(q){
  q=q.toLowerCase()
  if(!q)return result.innerHTML=""
  if(barcodeIndex.has(q)){
    beepOk.play()
    return render([barcodeIndex.get(q)])
  }
  const r=[]
  for(const x of nameIndex){
    if(x.name.includes(q)){
      r.push(x.product)
      if(r.length>=100)break
    }
  }
  r.length?beepOk.play():beepErr.play()
  render(r)
}

function render(list){
  result.innerHTML=list.map(p=>`
    <div class="card">
      <img src="${p.i}">
      <b>${p.n}</b>
      <small>${p.b}</small>
      <div>${p.h}</div>
    </div>`).join("")
}
</script>
</body>
</html>
