<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MMS-X</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h1>MMS-X</h1>
<h2>Product Query</h2>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Search here" autocomplete="off"/>
    <span id="clearBtn" title="Clear">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Scan Barcode</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<!-- AUDIO -->
<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= DATA ================= */
let barcodeIndex = new Map();
let nameIndex = [];
let history = [];
let html5Qr = null;

/* ================= LOAD PRODUCT ================= */
fetch('products.json')
  .then(r => r.json())
  .then(data => {
    for (const p of data) {
      p.b.split("/").forEach(code => {
        barcodeIndex.set(code.trim(), p);
      });
      nameIndex.push({ name: p.n.toLowerCase(), product: p });
    }
  });

/* ================= ELEMENT ================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
const readerEl = document.getElementById("reader");

/* ================= INPUT ================= */
input.addEventListener("input", e => {
  clearBtn.style.display = e.target.value ? "block" : "none";
  search(e.target.value);
});

clearBtn.onclick = () => {
  input.value = "";
  clearBtn.style.display = "none";
  clearResult();
  input.focus();
};

/* ================= SEARCH ================= */
function search(q) {
  q = q.trim().toLowerCase();
  if (!q) return clearResult();

  if (barcodeIndex.has(q)) {
    beep(true);
    addHistory(q);
    render([barcodeIndex.get(q)], q);
    return;
  }

  const results = [];
  for (let i = 0; i < nameIndex.length && results.length < 1000; i++) {
    if (nameIndex[i].name.includes(q)) {
      results.push(nameIndex[i].product);
    }
  }

  results.length ? beep(true) : beep(false);
  render(results, q);
}

/* ================= RENDER ================= */
function render(list, q="") {
  document.getElementById("result").innerHTML = list.map(p => `
    <div class="card ${p.b.includes(q) ? 'match' : ''}">
      <img src="${p.i}" loading="lazy">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div class="price">Regular : ${p.h}</div>
      </div>
    </div>
  `).join("");
}

function clearResult() {
  document.getElementById("result").innerHTML = "";
}

/* ================= SCANNER (BACK CAMERA FIX) ================= */
async function startScanner() {
  readerEl.innerHTML = "";

  if (html5Qr) {
    await html5Qr.stop().catch(()=>{});
  }

  const devices = await Html5Qrcode.getCameras();
  if (!devices || devices.length === 0) {
    alert("No camera found");
    return;
  }

  // ðŸ”¥ FORCE BACK CAMERA
  let backCam = devices.find(d =>
    d.label.toLowerCase().includes("back") ||
    d.label.toLowerCase().includes("rear")
  );

  if (!backCam) backCam = devices[devices.length - 1];

  html5Qr = new Html5Qrcode("reader");

  try {
    await html5Qr.start(
      backCam.id,
      {
        fps: 15,
        qrbox: { width: 300, height: 140 },
        disableFlip: true,
        videoConstraints: {
          focusMode: "continuous"
        }
      },
      code => {
        input.value = code;
        clearBtn.style.display = "block";
        beep(true);
        addHistory(code);
        search(code);
        html5Qr.stop();
      }
    );
  } catch (e) {
    alert("Camera permission denied / HTTPS required");
  }
}

document.getElementById("scanBtn").onclick = startScanner;

/* ================= HISTORY ================= */
function addHistory(code) {
  if (history.includes(code)) return;
  history.unshift(code);
  if (history.length > 5) history.pop();
  document.getElementById("history").innerHTML =
    history.map(h => `<span>${h}</span>`).join("");
}

/* ================= BEEP ================= */
function beep(ok) {
  (ok ? beepOk : beepErr).play();
}
</script>

</body>
</html>
