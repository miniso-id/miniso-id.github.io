<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Web Barcode Scanner</title>

<script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
body{
  font-family: system-ui, Arial, sans-serif;
  margin:0;
  padding:0;
  background:#f6f7f8;
}

header{
  padding:12px;
  background:#111;
  color:#fff;
  text-align:center;
  font-weight:600;
}

.container{
  padding:12px;
}

#searchInput{
  width:100%;
  padding:14px;
  font-size:18px;
  border:1px solid #ccc;
  border-radius:8px;
}

#scanBtn{
  width:100%;
  margin-top:10px;
  padding:14px;
  font-size:16px;
  background:#0d6efd;
  color:#fff;
  border:none;
  border-radius:8px;
}

#scanner{
  display:none;
  margin-top:12px;
  position:relative;
  width:100%;
  aspect-ratio: 3 / 4;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

/* View Finder */
#scanner::after{
  content:"";
  position:absolute;
  inset:20%;
  border:2px solid #00ff88;
  border-radius:12px;
  box-shadow:0 0 0 2000px rgba(0,0,0,0.35);
  pointer-events:none;
}
</style>
</head>

<body>

<header>Barcode Scanner</header>

<div class="container">
  <input id="searchInput" placeholder="Scan barcode atau ketik..." autofocus />
  <button id="scanBtn">ðŸ“· Scan Barcode</button>

  <div id="scanner"></div>
</div>

<script>
/* =========================
   STATE
========================= */
const input = document.getElementById("searchInput");
const scanBtn = document.getElementById("scanBtn");
const reader = document.getElementById("scanner");

let scanning = false;
let lastCode = "";
let stableCount = 0;
const REQUIRED_STABLE = 3;

let rearCameraIds = [];
let currentCamIndex = 0;
let focusTimeout = null;

/* =========================
   GET REAR CAMERAS
========================= */
async function getRearCameras(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  return devices
    .filter(d => d.kind === "videoinput")
    .filter(d => /back|rear|environment/i.test(d.label))
    .map(d => d.deviceId);
}

/* =========================
   START CAMERA BY INDEX
========================= */
async function startCameraByIndex(index){
  if(index >= rearCameraIds.length){
    alert("Barcode tidak terbaca. Coba jarak lain.");
    stopScanner();
    return;
  }

  currentCamIndex = index;

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target: reader,
      constraints:{
        deviceId:{ exact: rearCameraIds[index] },
        width:{ min:1280 },
        height:{ min:720 },
        facingMode:"environment"
      },
      area:{
        top:"22%",
        right:"22%",
        left:"22%",
        bottom:"22%"
      }
    },
    decoder:{
      readers:[
        "ean_reader",
        "ean_8_reader",
        "upc_reader",
        "upc_e_reader",
        "code_128_reader"
      ]
    },
    locate:true
  }, err => {
    if(err){
      startCameraByIndex(index + 1);
      return;
    }

    Quagga.start();
    Quagga.onDetected(onDetectedStable);

    focusTimeout = setTimeout(()=>{
      console.warn("Focus failed, switching camera");
      Quagga.offDetected(onDetectedStable);
      Quagga.stop();
      startCameraByIndex(index + 1);
    }, 5000);
  });
}

/* =========================
   STABLE DETECTION
========================= */
function onDetectedStable(res){
  const code = res.codeResult.code;

  if(code === lastCode){
    stableCount++;
  }else{
    lastCode = code;
    stableCount = 1;
  }

  if(stableCount < REQUIRED_STABLE) return;

  clearTimeout(focusTimeout);
  stopScanner();

  input.value = code;
  input.focus();
  input.select();
}

/* =========================
   STOP SCANNER
========================= */
function stopScanner(){
  try{
    Quagga.offDetected(onDetectedStable);
    Quagga.stop();
  }catch(e){}
  reader.style.display = "none";
  scanning = false;
}

/* =========================
   BUTTON HANDLER
========================= */
scanBtn.onclick = async () => {
  if(scanning) return;

  scanning = true;
  reader.style.display = "block";
  lastCode = "";
  stableCount = 0;

  rearCameraIds = await getRearCameras();

  if(!rearCameraIds.length){
    alert("Kamera belakang tidak ditemukan");
    scanning = false;
    return;
  }

  startCameraByIndex(0);
};

/* =========================
   PDA MODE (KEEP FOCUS)
========================= */
input.addEventListener("blur",()=>{
  setTimeout(()=>input.focus(),50);
});
</script>

</body>
</html>
