<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">

<!-- QUAGGA FALLBACK -->
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
#reader{
  display:none;
  position:relative;
  width:100%;
  max-width:420px;
  aspect-ratio:1/1;
  margin:12px auto;
  overflow:hidden;
  border-radius:14px;
  background:#000;
}
#reader video,#reader canvas{
  width:100%;
  height:100%;
  object-fit:cover;
}
#reader::after{
  content:"";
  position:absolute;
  inset:18%;
  border:2px dashed rgba(0,255,0,.6);
  border-radius:10px;
}
</style>
</head>

<body>

<h1>MMS-X</h1>
<h2>Product Query</h2>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Scan / Search" autocomplete="off" autofocus>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Scan Kamera</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
let barcodeIndex=new Map(),nameIndex=[],history=[],scanning=false,stream=null;

fetch('products.json').then(r=>r.json()).then(d=>{
 d.forEach(p=>{
  p.b.split("/").forEach(c=>barcodeIndex.set(c.trim(),p));
  nameIndex.push({name:p.n.toLowerCase(),product:p});
 });
});

const input=searchInput,reader=document.getElementById("reader");

/* PDA SCAN (ENTER) */
input.addEventListener("keydown",e=>{
 if(e.key==="Enter"){
  e.preventDefault();
  handleResult(input.value.trim());
 }
});

/* CAMERA BTN */
scanBtn.onclick=()=>{
 if(scanning) return;
 scanning=true;
 reader.style.display="block";
 if("BarcodeDetector"in window) startNative(); else startQuagga();
};

function startNative(){
 navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:1280}}})
 .then(s=>{
  stream=s;
  const v=document.createElement("video");
  v.srcObject=s;v.play();
  reader.innerHTML="";reader.appendChild(v);
  const det=new BarcodeDetector({formats:["ean_13","ean_8"]});
  const loop=setInterval(async()=>{
   const c=await det.detect(v);
   if(c.length){clearInterval(loop);handleResult(c[0].rawValue);}
  },300);
 });
}

function startQuagga(){
 Quagga.init({
  inputStream:{type:"LiveStream",target:reader,constraints:{facingMode:"environment",width:640,height:640}},
  decoder:{readers:["ean_reader","ean_8_reader"]},
  locator:{patchSize:"large",halfSample:false}
 },()=>Quagga.start());
 Quagga.onDetected(d=>handleResult(d.codeResult.code));
}

function handleResult(code){
 stopCamera();
 reader.style.display="none";
 scanning=false;
 if(!code) return;
 input.value=code;
 search(code);
 input.focus();input.select();
}

function stopCamera(){
 if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
 try{Quagga.stop();}catch{}
}

function search(q){
 if(barcodeIndex.has(q)){beepOk.play();render([barcodeIndex.get(q)]);}
 else{beepErr.play();render([]);}
}

function render(l){
 result.innerHTML=l.map(p=>`<div class="card"><img src="${p.i}"><div class="info"><b>${p.n}</b><small>${p.b}</small><div>${p.h}</div></div></div>`).join("");
}
</script>
</body>
</html>
