<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<style>
#reader{
  display:none;
  width:100%;
  max-width:360px;
  aspect-ratio:1/1;
  margin:10px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  position:relative;
}
#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}
#reader::after{
  content:"";
  position:absolute;
  inset:22%;
  border:2px dashed rgba(0,255,0,.7);
}
</style>
</head>

<body>

<center>
  <h2>Price Check</h2>
  <h3>MMS-X (Quagga2)</h3>
</center>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Loading product data..." disabled autocomplete="off">
    <span id="clearBtn">‚úï</span>
  </div>
  <button id="scanBtn" disabled>üì∑ Camera Scan</button>
</div>

<div id="reader"></div>

<center><h3>Scan History</h3></center>
<div id="history"></div>
<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= ELEMENT ================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
const scanBtn = document.getElementById("scanBtn");
const reader = document.getElementById("reader");
const result = document.getElementById("result");
const historyDiv = document.getElementById("history");
const beepOk = document.getElementById("beepOk");
const beepErr = document.getElementById("beepErr");

/* ================= STATE ================= */
let barcodeIndex = new Map();
let history = [];
let dataReady = false;
let scanning = false;
let lastCode = "";
let stableCount = 0;

/* ===== BLUR DETECT STATE ===== */
let blurTimer = null;
let blurSamples = [];
const BLUR_THRESHOLD = 120;      // makin kecil = makin sensitif
const BLUR_SAMPLE_LIMIT = 12;    // jumlah frame dicek
const BLUR_TIMEOUT = 1500;       // ms sebelum switch kamera

/* ================= LOAD DATA ================= */
fetch("/product/products.json")
.then(r=>r.json())
.then(data=>{
  data.forEach(p=>{
    if(p.b){
      p.b.split("/").forEach(code=>{
        barcodeIndex.set(code.trim(), p);
      });
    }
  });
  dataReady = true;
  input.disabled = false;
  scanBtn.disabled = false;
  input.placeholder = "Scan barcode / type here";
});

/* ================= SEARCH ================= */
input.oninput = e=>{
  clearBtn.style.display = e.target.value ? "block" : "none";
  search(e.target.value);
};

input.onkeydown = e=>{
  if(e.key === "Enter"){
    e.preventDefault();
    search(input.value);
    input.focus();
    input.select();
  }
};

clearBtn.onclick = ()=>{
  input.value="";
  clearBtn.style.display="none";
  result.innerHTML="";
  input.focus();
};

function search(q){
  if(!dataReady) return;
  q = q.trim();
  if(!q){
    result.innerHTML="";
    return;
  }
  if(barcodeIndex.has(q)){
    beepOk.play();
    addHistory(q);
    render([barcodeIndex.get(q)]);
  }else{
    beepErr.play();
    result.innerHTML="";
  }
}

/* ================= RENDER ================= */
function render(list){
  result.innerHTML = list.map(p=>`
    <div class="card">
      <img src="${p.i}" loading="lazy">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div>${p.h}</div>
      </div>
    </div>
  `).join("");
}

/* ================= HISTORY ================= */
function addHistory(code){
  if(history.includes(code)) return;
  history.unshift(code);
  if(history.length > 5) history.pop();
  historyDiv.innerHTML = history.map(h=>`<span>${h}</span>`).join("");
}

/* ================= CAMERA FILTER ================= */
async function getRearCamerasFiltered(){
  const devices = await navigator.mediaDevices.enumerateDevices();
  return devices.filter(d =>
    d.kind === "videoinput" &&
    !/front|user/i.test(d.label) &&          // blok kamera depan
    !/ultra|0\.5x|super/i.test(d.label)      // buang ultra-wide
  );
}

/* ================= BLUR DETECTION ================= */
function startBlurMonitor(onBlur){
  stopBlurMonitor();
  blurSamples = [];
  blurTimer = setInterval(()=>{
    const video = reader.querySelector("video");
    if(!video || video.readyState < 2) return;

    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video,0,0);

    const img = ctx.getImageData(0,0,canvas.width,canvas.height);
    let sum = 0, sumSq = 0;
    for(let i=0;i<img.data.length;i+=4){
      const g = img.data[i]*0.299 + img.data[i+1]*0.587 + img.data[i+2]*0.114;
      sum += g;
      sumSq += g*g;
    }
    const mean = sum / (img.data.length/4);
    const variance = (sumSq/(img.data.length/4)) - mean*mean;

    blurSamples.push(variance);
    if(blurSamples.length > BLUR_SAMPLE_LIMIT) blurSamples.shift();

    const avg = blurSamples.reduce((a,b)=>a+b,0) / blurSamples.length;
    if(avg < BLUR_THRESHOLD){
      stopBlurMonitor();
      onBlur();
    }
  }, 120);
}

function stopBlurMonitor(){
  if(blurTimer){
    clearInterval(blurTimer);
    blurTimer = null;
  }
}

/* ================= CAMERA SCAN (QUAGGA2) ================= */
scanBtn.onclick = async ()=>{
  if(scanning || !dataReady) return;

  scanning = true;
  reader.style.display = "block";
  lastCode = "";
  stableCount = 0;

  const cams = await getRearCamerasFiltered();
  let camIndex = 0;

  function startCam(deviceId){
    Quagga.init({
      inputStream:{
        name:"Live",
        type:"LiveStream",
        target:reader,
        constraints:{
          facingMode:"environment",
          deviceId: deviceId ? { exact: deviceId } : undefined,
          width:{ min:1280 },
          height:{ min:720 }
        },
        area:{ top:"22%", right:"22%", left:"22%", bottom:"22%" }
      },
      decoder:{
        readers:[
          "ean_reader",
          "ean_8_reader",
          "code_128_reader",
          "upc_reader",
          "upc_e_reader"
        ]
      },
      locate:true
    }, err=>{
      if(err){
        tryNext();
        return;
      }

      Quagga.start();

      // paksa zoom (anti wide)
      setTimeout(()=>{
        const track = Quagga.CameraAccess.getActiveTrack();
        const caps = track?.getCapabilities?.();
        if(caps?.zoom){
          track.applyConstraints({ advanced:[{ zoom: 3 }] });
        }
      },600);

      startBlurMonitor(()=>{
        tryNext();   // üîÅ AUTO SWITCH KAMERA SAAT BLUR
      });

      Quagga.onDetected(onDetectedStable);
    });
  }

  function tryNext(){
    stopBlurMonitor();
    Quagga.offDetected(onDetectedStable);
    Quagga.stop();
    camIndex++;
    if(camIndex < cams.length){
      startCam(cams[camIndex].deviceId);
    }else{
      reader.style.display="none";
      scanning=false;
      alert("Kamera blur / tidak fokus");
    }
  }

  startCam(cams[0]?.deviceId);
};

/* ================= STABLE DETECTION ================= */
function onDetectedStable(res){
  const code = res.codeResult.code;
  if(code === lastCode) stableCount++;
  else{
    lastCode = code;
    stableCount = 1;
  }
  if(stableCount < 3) return;

  stopBlurMonitor();
  Quagga.offDetected(onDetectedStable);
  Quagga.stop();

  reader.style.display="none";
  scanning = false;

  input.value = code;
  clearBtn.style.display = "block";
  search(code);
  input.focus();
  input.select();
}
</script>

</body>
</html>
