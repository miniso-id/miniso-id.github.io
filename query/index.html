<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">

<style>
/* input clear button behavior assumed from style.css */
</style>
</head>

<body>

<!-- APP -->
<center>
  <h2>Price Check</h2>
  <h3>MMS-X (beta)</h3>
</center>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Loading product data..." disabled>
    <span id="clearBtn">âœ•</span>
  </div>
</div>

<center><h3>Scan History</h3></center>
<div id="history"></div>
<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= INIT ================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
const result = document.getElementById("result");
const historyDiv = document.getElementById("history");
const beepOk = document.getElementById("beepOk");
const beepErr = document.getElementById("beepErr");

/* ================= STATE ================= */
let barcodeIndex = new Map();
let history = [];
let dataReady = false;

/* ================= FETCH & INDEX (BARCODE ONLY) ================= */
fetch("/product/products.json")
.then(r => r.json())
.then(data => {
  data.forEach(p => {
    if (p.b) {
      p.b.split("/").forEach(code => {
        barcodeIndex.set(code.trim(), p);
      });
    }
  });

  dataReady = true;
  input.disabled = false;
  input.placeholder = "Scan barcode / type here";
  input.focus();
});

/* ================= SEARCH ================= */
input.oninput = e => {
  clearBtn.style.display = e.target.value ? "block" : "none";
};

clearBtn.onclick = () => {
  input.value = "";
  result.innerHTML = "";
  input.focus();
};

function search(q){
  if (!dataReady) return;
  q = q.trim();
  if (!q){
    result.innerHTML = "";
    return;
  }

  if (barcodeIndex.has(q)){
    beepOk.play();
    addHistory(q);
    render([barcodeIndex.get(q)]);
  } else {
    beepErr.play();
    result.innerHTML = "";
  }
}

/* ================= SINGLE SCAN HANDLER ================= */
function handleScan(code){
  if (!code) return;

  input.value = code;
  search(code);

  // auto clear + siap scan ulang
  setTimeout(() => {
    input.value = "";
    input.focus();
  }, 200);
}

/* ================= PDT / HARDWARE SCANNER ================= */
// scanner biasanya kirim ENTER
input.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    handleScan(input.value.trim());
  }
});

// jaga cursor selalu standby
setInterval(() => {
  if (document.activeElement !== input) {
    input.focus();
  }
}, 1500);

/* ================= RENDER ================= */
function render(list){
  result.innerHTML = list.map(p => `
    <div class="card">
      <img src="${p.i}">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div>${p.h}</div>
      </div>
    </div>
  `).join("");
}

/* ================= HISTORY ================= */
function addHistory(code){
  if (history.includes(code)) return;
  history.unshift(code);
  if (history.length > 5) history.pop();
  historyDiv.innerHTML = history.map(h => `<span>${h}</span>`).join("");
}
</script>

</body>
</html>
