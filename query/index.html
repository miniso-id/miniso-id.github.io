<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
</head>

<body>

<h1>MMS-X</h1>
<h2>Product Query</h2>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Search here" autocomplete="off">
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Scan Barcode</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= DATA ================= */
let barcodeIndex = new Map();
let nameIndex = [];
let history = [];

fetch('products.json')
.then(r => r.json())
.then(data => {
  data.forEach(p => {
    p.b.split("/").forEach(c => barcodeIndex.set(c.trim(), p));
    nameIndex.push({ name: p.n.toLowerCase(), product: p });
  });
});

/* ================= ELEMENT ================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
const readerEl = document.getElementById("reader");

/* ================= SEARCH ================= */
input.addEventListener("input", e => {
  clearBtn.style.display = e.target.value ? "block" : "none";
  search(e.target.value);
});

clearBtn.onclick = () => {
  input.value = "";
  clearBtn.style.display = "none";
  document.getElementById("result").innerHTML = "";
};

function search(q) {
  q = q.trim().toLowerCase();
  if (!q) return;

  if (barcodeIndex.has(q)) {
    beep(true);
    addHistory(q);
    render([barcodeIndex.get(q)], q);
    return;
  }

  const res = [];
  for (const n of nameIndex) {
    if (n.name.includes(q)) {
      res.push(n.product);
      if (res.length >= 500) break;
    }
  }
  res.length ? beep(true) : beep(false);
  render(res, q);
}

/* ================= RENDER ================= */
function render(list, q="") {
  document.getElementById("result").innerHTML = list.map(p => `
    <div class="card ${p.b.includes(q) ? 'match' : ''}">
      <img src="${p.i}" loading="lazy">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div class="price">Regular : ${p.h}</div>
      </div>
    </div>
  `).join("");
}

/* ================= HISTORY ================= */
function addHistory(code) {
  if (history.includes(code)) return;
  history.unshift(code);
  if (history.length > 5) history.pop();
  document.getElementById("history").innerHTML =
    history.map(h => `<span>${h}</span>`).join("");
}

/* ================= BEEP ================= */
function beep(ok) {
  (ok ? beepOk : beepErr).play();
}

/* ================= ZXING SCANNER (FIXED) ================= */
let codeReader;
let scanning = false;

document.getElementById("scanBtn").onclick = async () => {
  if (scanning) return;
  scanning = true;
  readerEl.innerHTML = "";

  codeReader = new ZXing.BrowserMultiFormatReader();

  try {
    await codeReader.decodeFromConstraints(
      {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      },
      readerEl,
      (result, err) => {
        if (result) {
          const code = result.getText();

          input.value = code;
          clearBtn.style.display = "block";

          beep(true);
          addHistory(code);
          search(code);

          codeReader.reset();
          scanning = false;
        }
      }
    );
  } catch (e) {
    alert("Camera not available / permission denied");
    scanning = false;
  }
};
</script>

</body>
</html>
