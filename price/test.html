<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>

<style>
#reader{
  display:none;
  width:100%;
  max-width:360px;
  aspect-ratio:1/1;
  margin:10px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  position:relative;
}
#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}
#reader::after{
  content:"";
  position:absolute;
  inset:22%;
  border:2px dashed rgba(0,255,0,.7);
}
</style>
</head>

<body>

<center>
  <h2>Price Check</h2>
  <h3>MMS-X (beta)</h3>
</center>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Loading product data..." disabled>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn" disabled>ðŸ“· Camera Scan</button>
</div>

<div id="reader"></div>

<center><h3>Scan History</h3></center>
<div id="history"></div>
<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= ELEMENT ================= */
const input = document.getElementById("searchInput");
const clearBtn = document.getElementById("clearBtn");
const scanBtn = document.getElementById("scanBtn");
const reader = document.getElementById("reader");
const result = document.getElementById("result");
const historyDiv = document.getElementById("history");
const beepOk = document.getElementById("beepOk");
const beepErr = document.getElementById("beepErr");

/* ================= STATE ================= */
let barcodeIndex = new Map();
let history = [];
let dataReady = false;

let scanning = false;
let lastCode = "";
let stableCount = 0;
const STABLE_REQUIRED = 3;

/* ================= LOAD DATA ================= */
fetch("/product/products.json")
.then(r => r.json())
.then(data => {
  data.forEach(p => {
    if (p.b) {
      p.b.split("/").forEach(code => {
        barcodeIndex.set(code.trim(), p);
      });
    }
  });
  dataReady = true;
  input.disabled = false;
  scanBtn.disabled = false;
  input.placeholder = "Scan barcode / type here";
});

/* ================= SEARCH ================= */
input.oninput = e => {
  clearBtn.style.display = e.target.value ? "block" : "none";
  search(e.target.value);
};

clearBtn.onclick = () => {
  input.value = "";
  result.innerHTML = "";
  input.focus();
};

function search(q){
  q = q.trim();
  if (!q) return;

  if (barcodeIndex.has(q)) {
    beepOk.play();
    addHistory(q);
    render([barcodeIndex.get(q)]);
  } else {
    beepErr.play();
    result.innerHTML = "";
  }
}

/* ================= RENDER ================= */
function render(list){
  result.innerHTML = list.map(p => `
    <div class="card">
      <img src="${p.i}" loading="lazy">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div>${p.h}</div>
      </div>
    </div>
  `).join("");
}

/* ================= HISTORY ================= */
function addHistory(code){
  if (history.includes(code)) return;
  history.unshift(code);
  if (history.length > 5) history.pop();
  historyDiv.innerHTML = history.map(h => `<span>${h}</span>`).join("");
}

/* ================= STOP SCAN ================= */
function stopScan(){
  try {
    Quagga.offDetected(onDetectedStable);
    Quagga.stop();
  } catch(e){}
  scanning = false;
  reader.style.display = "none";
}

/* ================= DETECT ================= */
function onDetectedStable(res){
  const code = res.codeResult.code;

  if (code === lastCode) stableCount++;
  else {
    lastCode = code;
    stableCount = 1;
  }

  if (stableCount < STABLE_REQUIRED) return;

  stopScan();

  input.value = code;
  clearBtn.style.display = "block";
  search(code);
  input.focus();
  input.select();
}

/* ================= START CAMERA ================= */
function startCamera(){
  lastCode = "";
  stableCount = 0;

  Quagga.init({
    inputStream: {
      type: "LiveStream",
      target: reader,
      constraints: {
        facingMode: "environment",   // ðŸ”’ ALWAYS REAR CAMERA
        width: { min: 1280 },
        height: { min: 720 }
      },
      area: { top:"22%", right:"22%", left:"22%", bottom:"22%" }
    },
    decoder: {
      readers: [
        "ean_reader",
        "ean_8_reader",
        "upc_reader",
        "upc_e_reader",
        "code_128_reader"
      ]
    },
    locate: true
  }, err => {
    if (err) {
      stopScan();
      return;
    }

    Quagga.start();

    setTimeout(() => {
      const track = Quagga.CameraAccess.getActiveTrack();
      if (track) {
        const caps = track.getCapabilities();
        if (caps.focusMode) {
          track.applyConstraints({ advanced:[{ focusMode:"continuous" }] });
        }
        if (caps.zoom) {
          track.applyConstraints({ advanced:[{ zoom: 3 }] });
        }
      }
    }, 600);

    Quagga.onDetected(onDetectedStable);
  });
}

/* ================= SCAN BUTTON ================= */
scanBtn.onclick = () => {
  if (!dataReady || scanning) return;
  scanning = true;
  reader.style.display = "block";
  startCamera();
};
</script>

</body>
</html>
