<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <div class="login-card">
    <h3>Login MMS-X</h3>

    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">

    <button onclick="doLogin()">Masuk</button>
    <div id="loginErr"></div>
  </div>
</div>

<!-- APP -->
<div id="app">

  <h2>Product Query</h2>
  <h3>MMS-X (beta test)</h3>

  <div id="userInfo"></div>
  <button class="logout-btn" onclick="logout()">Logout</button>

  <div class="search-box">
    <div class="input-wrap">
      <input id="searchInput" placeholder="Scan barcode / type here" autofocus>
      <span id="clearBtn">âœ•</span>
    </div>
    <button id="scanBtn">ðŸ“· Camera Scan</button>
  </div>

  <div id="reader"></div>

  <h3 id="historyTitle">Scan History</h3>
  <div id="history"></div>

  <div id="result" class="grid"></div>

  <audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
  <audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

</div>

<script>
/* ================= USER DATABASE ================= */
const USERS=[
  {user:"admin",pass:"admin123",role:"admin",name:"Admin MMS"},
  {user:"staff1",pass:"1234",role:"staff",name:"Staff A"},
  {user:"staff2",pass:"1234",role:"staff",name:"Staff B"}
]

/* ================= AUTH ================= */
const app=document.getElementById("app")
const loginBox=document.getElementById("loginBox")
const card=document.querySelector(".login-card")

function checkAuth(){
  const auth=JSON.parse(localStorage.getItem("mms_auth"))
  if(auth){
    loginBox.style.display="none"
    app.style.display="block"
    userInfo.innerText=`Login: ${auth.name} (${auth.role})`
    if(auth.role!=="admin"){
      history.style.display="none"
      historyTitle.style.display="none"
    }
  }else{
    loginBox.style.display="flex"
    app.style.display="none"
  }
}

function doLogin(){
  const u=loginUser.value.trim()
  const p=loginPass.value.trim()
  const found=USERS.find(x=>x.user===u && x.pass===p)

  if(found){
    localStorage.setItem("mms_auth",JSON.stringify(found))
    checkAuth()
  }else{
    loginErr.innerText="Username atau password salah"
    loginErr.classList.add("show")

    card.classList.remove("error")
    void card.offsetWidth
    card.classList.add("error")
  }
}

loginUser.oninput=loginPass.oninput=()=>{
  loginErr.classList.remove("show")
  card.classList.remove("error")
}

function logout(){
  localStorage.removeItem("mms_auth")
  location.reload()
}

checkAuth()
</script>

<script>
/* ================= APP SCRIPT (ASLI) ================= */
const input=document.getElementById("searchInput")
const clearBtn=document.getElementById("clearBtn")
const reader=document.getElementById("reader")
const historyDiv=document.getElementById("history")
const result=document.getElementById("result")

let barcodeIndex=new Map(),nameIndex=[],history=[]

fetch("products.json").then(r=>r.json()).then(data=>{
  data.forEach(p=>{
    p.b.split("/").forEach(c=>barcodeIndex.set(c.trim(),p))
    nameIndex.push({name:p.n.toLowerCase(),product:p})
  })
})

input.oninput=e=>{
  clearBtn.style.display=e.target.value?"block":"none"
  search(e.target.value)
}

input.onkeydown=e=>{
  if(e.key==="Enter"){
    e.preventDefault()
    search(input.value.trim())
  }
}

clearBtn.onclick=()=>{
  input.value=""
  clearBtn.style.display="none"
  result.innerHTML=""
}

function search(q){
  q=q.toLowerCase()
  if(!q){result.innerHTML="";return}

  if(barcodeIndex.has(q)){
    beepOk.play()
    addHistory(q)
    render([barcodeIndex.get(q)])
    return
  }

  const r=[]
  for(let i=0;i<nameIndex.length;i++){
    if(nameIndex[i].name.includes(q)){
      r.push(nameIndex[i].product)
      if(r.length>=100)break
    }
  }
  r.length?beepOk.play():beepErr.play()
  render(r)
}

function render(list){
  result.innerHTML=list.map(p=>`
    <div class="card">
      <img src="${p.i}">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div>${p.h}</div>
      </div>
    </div>
  `).join("")
}

function addHistory(code){
  if(history.includes(code))return
  history.unshift(code)
  if(history.length>5)history.pop()
  historyDiv.innerHTML=history.map(h=>`<span>${h}</span>`).join("")
}
</script>

</body>
</html>
