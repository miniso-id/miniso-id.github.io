<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
#reader{
  display:none;
  width:100%;
  max-width:360px;
  aspect-ratio:1/1;
  margin:10px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  position:relative;
}
#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}
#reader::after{
  content:"";
  position:absolute;
  inset:18%; /* FIX: lebih besar */
  border:2px dashed rgba(0,255,0,.7);
  pointer-events:none;
}
#history span{
  margin:4px;
  padding:4px 8px;
  background:#eee;
  border-radius:6px;
  display:inline-block;
  font-size:12px;
}
</style>
</head>

<body>

<center>
  <h2>Price Check</h2>
  <h3>MMS-X (beta)</h3>
</center>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Loading product data..." disabled>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn" disabled>ðŸ“· Camera Scan</button>
</div>

<div id="reader"></div>

<center><h3>Scan History</h3></center>
<div id="history"></div>
<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

<script>
/* ================= INIT ================= */
const input=document.getElementById("searchInput");
const clearBtn=document.getElementById("clearBtn");
const scanBtn=document.getElementById("scanBtn");
const reader=document.getElementById("reader");
const result=document.getElementById("result");
const historyDiv=document.getElementById("history");
const beepOk=document.getElementById("beepOk");
const beepErr=document.getElementById("beepErr");

/* ================= STATE ================= */
let barcodeIndex=new Map();
let history=[];
let dataReady=false;

/* ================= FETCH DATA ================= */
fetch("/product/products.json")
.then(r=>r.json())
.then(data=>{
  data.forEach(p=>{
    if(p.b){
      p.b.split("/").forEach(code=>{
        barcodeIndex.set(code.trim(),p);
      });
    }
  });
  dataReady=true;
  input.disabled=false;
  scanBtn.disabled=false;
  input.placeholder="Scan barcode / type here";
});

/* ================= SEARCH ================= */
input.oninput=e=>{
  clearBtn.style.display=e.target.value?"block":"none";
  search(e.target.value);
};

clearBtn.onclick=()=>{
  input.value="";
  result.innerHTML="";
};

function search(q){
  if(!dataReady)return;
  q=q.trim();
  if(!q){ result.innerHTML=""; return; }

  if(barcodeIndex.has(q)){
    beepOk.play();
    addHistory(q);
    render([barcodeIndex.get(q)]);
  }else{
    beepErr.play();
    result.innerHTML="";
  }
}

/* ================= RENDER ================= */
function render(list){
  result.innerHTML=list.map(p=>`
    <div class="card">
      <img src="${p.i}">
      <div class="info">
        <b>${p.n}</b>
        <small>${p.b}</small>
        <div>
          <div>Regular: Rp${p.r}${p.rp?` (${p.rp})`:""}</div>
          <div>Street: Rp${p.s}${p.sp?` (${p.sp})`:""}</div>
        </div>
      </div>
    </div>
  `).join("");
}

/* ================= HISTORY ================= */
function addHistory(code){
  if(history.includes(code))return;
  history.unshift(code);
  if(history.length>5)history.pop();
  historyDiv.innerHTML=history.map(h=>`<span>${h}</span>`).join("");
}

/* ================= CAMERA (FIXED) ================= */
let scanning=false,lastCode="",stableCount=0;
let zoomLevel=2,zoomMin=1,zoomMax=3,lastZoomAdjust=0;

scanBtn.onclick=()=>{
  if(scanning||!dataReady)return;
  scanning=true;
  reader.style.display="block";

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:reader,
      constraints:{
        facingMode:{ exact:"environment" },
        width:{ ideal:1920 },
        height:{ ideal:1080 },
        focusMode:"continuous"
      },
      area:{                /* FIX: area diperbesar */
        top:"18%",
        right:"18%",
        left:"18%",
        bottom:"18%"
      }
    },
    decoder:{
      readers:[
        "ean_reader",
        "code_128_reader",
        "code_39_reader",
        "upc_reader",
        "upc_e_reader"
      ]
    },
    locate:true
  },err=>{
    if(err){
      scanning=false;
      reader.style.display="none";
      return;
    }

    Quagga.start();

    /* INIT ZOOM */
    setTimeout(()=>{
      const track=Quagga.CameraAccess.getActiveTrack();
      if(!track)return;
      const caps=track.getCapabilities();
      if(caps.zoom){
        zoomMin=caps.zoom.min||1;
        zoomMax=caps.zoom.max||3;
        zoomLevel=Math.min(2,zoomMax);
        track.applyConstraints({ advanced:[{ zoom:zoomLevel }] });
      }
    },500);

    Quagga.onDetected(res=>{
      const code=res.codeResult.code;
      const decoded=res.codeResult.decodedCodes||[];

      /* FIX: validasi lebih realistis */
      let avgError = decoded.length
        ? decoded.reduce((s,d)=>s+(d.error||1),0)/decoded.length
        : 1;

      const valid = decoded.length>=3 && avgError<0.35;

      autoZoom(valid?"good":"bad");

      /* FIX: stability logic */
      if(code===lastCode){
        if(valid) stableCount++;
      }else{
        lastCode=code;
        stableCount= valid ? 1 : 0;
      }

      if(stableCount>=2){
        Quagga.stop();
        scanning=false;
        reader.style.display="none";
        stableCount=0;
        lastCode="";
        input.value=code;
        search(code);
      }
    });
  });
};

/* ================= AUTO ZOOM (FIXED) ================= */
function autoZoom(mode){
  const now=Date.now();
  if(now-lastZoomAdjust<1000)return;

  const track=Quagga.CameraAccess.getActiveTrack();
  if(!track)return;

  if(mode==="bad" && zoomLevel<zoomMax){
    zoomLevel+=0.2;
  }
  if(mode==="good" && zoomLevel>zoomMin+0.7){
    zoomLevel-=0.1;
  }

  zoomLevel=Math.max(zoomMin,Math.min(zoomLevel,zoomMax));

  track.applyConstraints({
    advanced:[{ zoom:zoomLevel }]
  });

  lastZoomAdjust=now;
}
</script>

</body>
</html>
