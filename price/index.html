<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
/* ===== LOGIN ===== */
#login{
  position:fixed;
  inset:0;
  background:#f4f4f4;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.login-box{
  background:#fff;
  padding:24px;
  width:90%;
  max-width:320px;
  border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
}
.login-box input,
.login-box button{
  width:100%;
  padding:12px;
  font-size:18px;
  margin-bottom:10px;
}

/* ===== CAMERA ===== */
#reader{
  display:none;
  width:100%;
  max-width:360px;
  aspect-ratio:1/1;
  margin:10px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  position:relative;
}
#reader video{width:100%;height:100%;object-fit:cover;}
#reader::after{
  content:"";
  position:absolute;
  inset:20%;
  border:2px dashed rgba(0,255,0,.7);
  border-radius:8px;
}

#logoutBtn{float:right;font-size:14px;}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
  <div class="login-box">
    <h2>PIN Login</h2>
    <input id="pin" type="password" inputmode="numeric" maxlength="6" placeholder="Masukkan PIN" autofocus>
    <button onclick="loginPin()">Masuk</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">

<button id="logoutBtn" onclick="logout()">Logout</button>

<h1>MMS-X</h1>
<h2>Product Query</h2>

<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Scan barcode / ketik nama" autofocus>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Scan Kamera</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

</div>

<script>
/* ===================================================
   USER CONFIG (PLAINTEXT PIN)
   =================================================== */
const PIN_USERS = {
  "1111": { name:"admin", role:"supervisor" },
  "2222": { name:"staff1", role:"staff" },
  "3333": { name:"staff2", role:"staff" }
};

const SESSION_DURATION = 8 * 60 * 60 * 1000; // 8 jam

/* ===================================================
   LOGIN
   =================================================== */
function loginPin(){
  const p = pin.value.trim();
  const u = PIN_USERS[p];
  if(!u){
    alert("PIN salah");
    pin.value="";
    return;
  }
  localStorage.setItem("mms_login","1");
  localStorage.setItem("mms_user",u.name);
  localStorage.setItem("mms_role",u.role);
  localStorage.setItem("mms_login_time",Date.now());
  showApp();
}

function logout(){
  localStorage.clear();
  location.reload();
}

/* AUTO LOGIN */
if(localStorage.getItem("mms_login")==="1"){
  showApp();
}

/* AUTO LOGOUT */
setInterval(()=>{
  const t = localStorage.getItem("mms_login_time");
  if(!t) return;
  if(Date.now()-Number(t) > SESSION_DURATION){
    alert("Session habis");
    logout();
  }
},60000);

/* ===================================================
   APP INIT
   =================================================== */
const loginDiv=document.getElementById("login");
const app=document.getElementById("app");
const input=document.getElementById("searchInput");
const clearBtn=document.getElementById("clearBtn");
const reader=document.getElementById("reader");

function showApp(){
  loginDiv.style.display="none";
  app.style.display="block";
  const u=localStorage.getItem("mms_user");
  const r=localStorage.getItem("mms_role");
  document.querySelector("h1").innerText=`MMS-X (${u} - ${r})`;
  input.focus();
}

/* ===================================================
   DATA
   =================================================== */
let barcodeIndex=new Map(), nameIndex=[], history=[];

fetch("products.json").then(r=>r.json()).then(data=>{
  data.forEach(p=>{
    p.b.split("/").forEach(c=>barcodeIndex.set(c.trim(),p));
    nameIndex.push({name:p.n.toLowerCase(),product:p});
  });
});

/* ===================================================
   SEARCH
   =================================================== */
input.oninput=e=>{
  clearBtn.style.display=e.target.value?"block":"none";
  search(e.target.value);
};

input.onkeydown=e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    search(input.value.trim());
  }
};

clearBtn.onclick=()=>{
  input.value="";
  clearBtn.style.display="none";
  result.innerHTML="";
  input.focus();
};

function search(q){
  q=q.toLowerCase();
  if(!q){result.innerHTML="";return;}

  if(barcodeIndex.has(q)){
    beepOk.play();
    addHistory(q);
    render([barcodeIndex.get(q)]);
    return;
  }

  const r=[];
  for(let i=0;i<nameIndex.length;i++){
    if(nameIndex[i].name.includes(q)){
      r.push(nameIndex[i].product);
      if(r.length>=100)break;
    }
  }
  r.length?beepOk.play():beepErr.play();
  render(r);
}

function render(list){
  result.innerHTML=list.map(p=>`
  <div class="card">
    <img src="${p.i}">
    <div class="info">
      <b>${p.n}</b>
      <small>${p.b}</small>
      <div>${p.h}</div>
    </div>
  </div>`).join("");
}

/* ===================================================
   HISTORY
   =================================================== */
function addHistory(code){
  if(history.includes(code))return;
  history.unshift(code);
  if(history.length>5)history.pop();
  historyDiv.innerHTML=history.map(h=>`<span>${h}</span>`).join("");
}
const historyDiv=document.getElementById("history");

/* ===================================================
   CAMERA (EAN)
   =================================================== */
let scanning=false;

scanBtn.onclick=()=>{
  if(scanning)return;
  scanning=true;
  reader.style.display="block";

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:reader,
      constraints:{facingMode:"environment"}
    },
    decoder:{readers:["ean_reader","ean_8_reader"]}
  },err=>{
    if(err){alert("Camera error");scanning=false;return;}
    Quagga.start();
  });

  Quagga.onDetected(d=>{
    Quagga.stop();
    reader.style.display="none";
    scanning=false;
    input.value=d.codeResult.code;
    clearBtn.style.display="block";
    search(input.value);
    input.focus();
    input.select();
  });
};
</script>

</body>
</html>
