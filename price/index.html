<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>MMS-X</title>

<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
/* ===== LOGIN OVERLAY ===== */
#loginOverlay{
  position:fixed;
  inset:0;
  background:#f3f4f6;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.login-card{
  width:100%;
  max-width:360px;
  padding:28px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  text-align:center;
  box-sizing:border-box;
}

.login-card *{box-sizing:border-box}

.login-card h3{
  margin-bottom:22px;
}

.login-card input{
  width:100%;
  height:44px;
  margin-bottom:14px;
  padding:0 14px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:15px;
}

.login-card button{
  width:100%;
  height:46px;
  border:none;
  border-radius:10px;
  background:#4f46e5;
  color:#fff;
  font-size:15px;
  cursor:pointer;
}

#loginErr{
  margin-top:10px;
  color:#ef4444;
  font-size:14px;
  opacity:0;
  transition:.25s;
}

#loginErr.show{opacity:1}

.login-card.error{
  animation:shake .35s;
}

@keyframes shake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-6px)}
  50%{transform:translateX(6px)}
  75%{transform:translateX(-4px)}
  100%{transform:translateX(0)}
}

/* ===== CAMERA (ASLI â€“ TIDAK DIUBAH) ===== */
#reader{
  display:none;
  width:100%;
  max-width:360px;
  aspect-ratio:1/1;
  margin:10px auto;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  position:relative;
}
#reader video{
  width:100%;
  height:100%;
  object-fit:cover;
}
#reader::after{
  content:"";
  position:absolute;
  inset:22%;
  border:2px dashed rgba(0,255,0,.7);
  border-radius:8px;
}
</style>
</head>

<body>

<!-- ===== LOGIN ===== -->
<div id="loginOverlay">
  <div class="login-card">
    <h3>Login MMS-X</h3>
    <input id="loginUser" placeholder="Username">
    <input id="loginPass" type="password" placeholder="Password">
    <button onclick="doLogin()">Masuk</button>
    <div id="loginErr">Username atau password salah</div>
  </div>
</div>

<!-- ===== APP (ASLI â€“ TIDAK DIUBAH) ===== -->
<div id="app" style="display:none">
<center>
<h2>Product Query</h2>
<h3>MMS-X (beta test)</h3>
</center>
<div class="search-box">
  <div class="input-wrap">
    <input id="searchInput" placeholder="Scan barcode / type here" autofocus>
    <span id="clearBtn">âœ•</span>
  </div>
  <button id="scanBtn">ðŸ“· Camera Scan</button>
</div>

<div id="reader"></div>

<h3>Scan History</h3>
<div id="history"></div>

<div id="result" class="grid"></div>

<audio id="beepOk" src="https://assets.mixkit.co/sfx/preview/mixkit-confirmation-tone-2867.mp3"></audio>
<audio id="beepErr" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3"></audio>

</div>

<script>
/* ================= LOGIN SYSTEM ================= */
let USERS=[]
fetch("users.json").then(r=>r.json()).then(d=>USERS=d)

const loginOverlay=document.getElementById("loginOverlay")
const app=document.getElementById("app")
const loginErr=document.getElementById("loginErr")

function doLogin(){
  const u=loginUser.value.trim()
  const p=loginPass.value.trim()
  const found=USERS.find(x=>x.user===u && x.pass===p)

  if(found){
    localStorage.setItem("mms_auth",JSON.stringify({
      user:found.user,
      role:found.role,
      time:Date.now()
    }))
    loginOverlay.style.display="none"
    app.style.display="block"
    applyRole(found.role)
    startIdleTimer()
    searchInput.focus()
  }else{
    loginErr.classList.add("show")
    const card=document.querySelector(".login-card")
    card.classList.remove("error")
    void card.offsetWidth
    card.classList.add("error")
  }
}

loginUser.oninput=loginPass.oninput=()=>{
  loginErr.classList.remove("show")
}

/* AUTO LOGIN */
(function(){
  const auth=localStorage.getItem("mms_auth")
  if(auth){
    loginOverlay.style.display="none"
    app.style.display="block"
    startIdleTimer()
  }
})()

/* ROLE */
function applyRole(role){
  document.body.dataset.role=role
}

/* AUTO LOGOUT */
let idleTimer
const IDLE_LIMIT=15*60*1000
function startIdleTimer(){
  resetIdle()
  ;["mousemove","keydown","click","touchstart"].forEach(e=>{
    document.addEventListener(e,resetIdle)
  })
}
function resetIdle(){
  clearTimeout(idleTimer)
  idleTimer=setTimeout(()=>{
    localStorage.removeItem("mms_auth")
    location.reload()
  },IDLE_LIMIT)
}
</script>

<!-- ================= SCRIPT ASLI (TIDAK DIUBAH) ================= -->
<script>
/* =====================================================
   INIT
   ===================================================== */
const input=document.getElementById("searchInput");
const clearBtn=document.getElementById("clearBtn");
const reader=document.getElementById("reader");
const historyDiv=document.getElementById("history");
const result=document.getElementById("result");

/* =====================================================
   DATA
   ===================================================== */
let barcodeIndex=new Map(), nameIndex=[], history=[];

fetch("https://script.google.com/macros/s/AKfycbwGX0iqcLgCMWVfoN0nRygA6-YLfkBe9f3ZWKCdjZLO/dev").then(r=>r.json()).then(data=>{
  data.forEach(p=>{
    p.b.split("/").forEach(c=>barcodeIndex.set(c.trim(),p));
    nameIndex.push({name:p.n.toLowerCase(),product:p});
  });
});

/* =====================================================
   SEARCH
   ===================================================== */
input.oninput=e=>{
  clearBtn.style.display=e.target.value?"block":"none";
  search(e.target.value);
};

input.onkeydown=e=>{
  if(e.key==="Enter"){
    e.preventDefault();
    search(input.value.trim());
  }
};

clearBtn.onclick=()=>{
  input.value="";
  clearBtn.style.display="none";
  result.innerHTML="";
  input.focus();
};

function search(q){
  q=q.toLowerCase();
  if(!q){result.innerHTML="";return;}

  if(barcodeIndex.has(q)){
    beepOk.play();
    addHistory(q);
    render([barcodeIndex.get(q)]);
    return;
  }

  const r=[];
  for(let i=0;i<nameIndex.length;i++){
    if(nameIndex[i].name.includes(q)){
      r.push(nameIndex[i].product);
      if(r.length>=100)break;
    }
  }
  r.length?beepOk.play():beepErr.play();
  render(r);
}

function render(list){
  result.innerHTML=list.map(p=>`
  <div class="card">
    <img src="${p.i}" loading="lazy">
    <div class="info">
      <b>${p.n}</b>
      <small>${p.b}</small>
      <div>${p.h}</div>
    </div>
  </div>`).join("");
}

/* =====================================================
   HISTORY
   ===================================================== */
function addHistory(code){
  if(history.includes(code))return;
  history.unshift(code);
  if(history.length>5)history.pop();
  historyDiv.innerHTML=history.map(h=>`<span>${h}</span>`).join("");
}

/* =====================================================
   CAMERA â€“ STABLE SCAN
   ===================================================== */
let scanning=false;
let lastCode="";
let stableCount=0;
const REQUIRED_MATCH=3;

scanBtn.onclick=()=>{
  if(scanning)return;
  scanning=true;
  reader.style.display="block";
  lastCode="";
  stableCount=0;

  Quagga.init({
    inputStream:{
      type:"LiveStream",
      target:reader,
      constraints:{
        facingMode:"environment",
        width:{ideal:1280},
        height:{ideal:720}
      },
      area:{top:"22%",right:"22%",left:"22%",bottom:"22%"}
    },
    locator:{halfSample:true},
    decoder:{readers:["ean_reader","ean_8_reader"]},
    locate:true
  },err=>{
    if(err){alert("Camera error");scanning=false;return;}
    Quagga.start();
    Quagga.onDetected(onDetectedStable);
  });
};

function onDetectedStable(res){
  const code=res.codeResult.code;
  if(code===lastCode){
    stableCount++;
  }else{
    lastCode=code;
    stableCount=1;
  }
  if(stableCount<REQUIRED_MATCH)return;

  Quagga.offDetected(onDetectedStable);
  Quagga.stop();
  reader.style.display="none";
  scanning=false;

  input.value=code;
  clearBtn.style.display="block";
  search(code);
  input.focus();
  input.select();
}
</script>

</body>
</html>
